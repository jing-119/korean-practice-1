<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>éŸ“èªå–®å­—ï¼‹æ–‡æ³•ç·´ç¿’å·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:," />
  <style>
    .tab-active{ @apply bg-slate-900 text-white } /* requires JIT; fallback below */
    .btn{ @apply px-3 py-2 rounded-xl shadow text-sm border border-slate-300 } 
    .btn-primary{ @apply bg-slate-900 text-white border-slate-900 }
    .btn-ghost{ @apply border-transparent text-slate-700 }
    .chip{ @apply text-xs px-2 py-1 rounded-full bg-slate-100 border border-slate-200 }
    /* Fallback for environments without Tailwind JIT @apply: */
    .btn{ padding:.5rem .75rem;border-radius:1rem;box-shadow:0 1px 2px rgba(0,0,0,.08);font-size:.9rem;border:1px solid #cbd5e1 }
    .btn-primary{ background:#0f172a;color:#fff;border-color:#0f172a }
    .btn-ghost{ border-color:transparent;color:#334155 }
    .chip{ font-size:.75rem;padding:.25rem .5rem;border-radius:9999px;background:#f1f5f9;border:1px solid #e2e8f0 }
    .tab-active{ background:#0f172a;color:#fff }
    input[type="date"]{ color-scheme: light; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex items-center gap-3 mb-4">
      <h1 class="text-2xl md:text-3xl font-bold">éŸ“èªå–®å­—ï¼‹æ–‡æ³•ç·´ç¿’å·¥å…·</h1>
      <span class="chip">é›¢ç·šå¯ç”¨ / localStorage</span>
      <span class="chip">JSON åŒ¯å…¥/åŒ¯å‡º</span>
    </header>

    <!-- Nav Tabs -->
    <nav class="flex flex-wrap gap-2 mb-6">
      <button class="btn tab-btn tab-active" data-tab="review">é–±è®€å¡/è¤‡ç¿’</button>
      <button class="btn tab-btn" data-tab="quiz">æ¸¬é©—ï¼ˆé¸æ“‡é¡Œ/æ‹¼å¯«é¡Œï¼‰</button>
      <button class="btn tab-btn" data-tab="grammar">æ–‡æ³•ï¼ˆé¡Œåº«å¯è‡ªè¨‚ï¼‰</button>
      <button class="btn tab-btn" data-tab="vocab">å–®å­—åº«ï¼ˆæœå°‹/æ’åº/ç·¨è¼¯/åˆªé™¤ï¼‰</button>
      <button class="btn tab-btn" data-tab="settings">è¨­å®š / åŒ¯å…¥åŒ¯å‡º</button>
    </nav>

    <!-- Main Panels -->
    <section id="panel-review" class="tab-panel">
      <div class="grid md:grid-cols-3 gap-4 items-start">
        <div class="md:col-span-2">
          <div id="flashcard" class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6 min-h-[220px] flex flex-col justify-between">
            <div>
              <div class="text-sm text-slate-500">ä»Šæ—¥åˆ°æœŸ / æœªè¤‡ç¿’ï¼š</div>
              <div class="mt-1 text-3xl font-semibold" id="card-front">â€”</div>
              <div class="mt-2 text-slate-500" id="card-meta"></div>
              <div class="mt-4 hidden" id="card-back">
                <div class="text-lg"><span class="font-semibold">é‡‹ç¾©ï¼š</span><span id="card-meaning"></span></div>
                <div class="mt-2 text-sm" id="card-example"></div>
              </div>
            </div>
            <div class="flex gap-2 mt-6">
              <button id="btn-show" class="btn">é¡¯ç¤ºç­”æ¡ˆ</button>
              <button id="btn-forgot" class="btn" disabled>å¿˜è¨˜</button>
              <button id="btn-good" class="btn btn-primary" disabled>è¨˜å¾—</button>
              <button id="btn-skip" class="btn" title="è·³éæ­¤å¡">è·³é</button>
            </div>
          </div>
        </div>
        <aside class="space-y-3">
          <div class="rounded-2xl bg-white border border-slate-200 p-4">
            <div class="font-semibold mb-2">è¤‡ç¿’çµ±è¨ˆï¼ˆä»Šæ—¥ï¼‰</div>
            <div class="text-sm" id="review-stats">â€”</div>
          </div>
          <div class="rounded-2xl bg-white border border-slate-200 p-4">
            <div class="font-semibold mb-2">Leitner ç›’</div>
            <div id="leitner-boxes" class="grid grid-cols-5 gap-2 text-center text-xs"></div>
          </div>
        </aside>
      </div>
    </section>

    <section id="panel-quiz" class="tab-panel hidden">
      <div class="grid md:grid-cols-2 gap-4 items-start">
        <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">é¸æ“‡é¡Œ</h2>
            <button id="btn-next-mcq" class="btn">æ›ä¸€é¡Œ</button>
          </div>
          <div id="mcq-area">
            <div id="mcq-question" class="text-xl font-semibold mb-3">â€”</div>
            <div id="mcq-options" class="space-y-2"></div>
            <div id="mcq-feedback" class="mt-3 text-sm">Â </div>
          </div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">æ‹¼å¯«é¡Œ</h2>
            <button id="btn-next-spell" class="btn">æ›ä¸€é¡Œ</button>
          </div>
          <div id="spell-area">
            <div id="spell-prompt" class="text-xl font-semibold mb-3">â€”</div>
            <input id="spell-input" class="w-full border border-slate-300 rounded-xl px-3 py-2" placeholder="è¼¸å…¥å°æ‡‰çš„éŸ“æ–‡æ‹¼å¯«â€¦" />
            <div class="flex gap-2 mt-3">
              <button id="btn-check-spell" class="btn btn-primary">æª¢æŸ¥</button>
              <button id="btn-show-spell" class="btn">é¡¯ç¤ºç­”æ¡ˆ</button>
            </div>
            <div id="spell-feedback" class="mt-3 text-sm">Â </div>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-grammar" class="tab-panel hidden">
      <div class="grid md:grid-cols-3 gap-4 items-start">
        <div class="md:col-span-2 rounded-2xl bg-white border border-slate-200 shadow-sm p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold">æ–‡æ³•æ¸¬é©—</h2>
            <button id="btn-next-gram" class="btn">æ›ä¸€é¡Œ</button>
          </div>
          <div id="gram-area">
            <div id="gram-question" class="text-lg font-semibold mb-3">â€”</div>
            <div id="gram-options" class="space-y-2"></div>
            <div id="gram-feedback" class="mt-3 text-sm">Â </div>
          </div>
        </div>
        <aside class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6">
          <h3 class="font-semibold mb-2">æ–°å¢æ–‡æ³•é¡Œ</h3>
          <form id="gram-form" class="space-y-2">
            <input required class="w-full border border-slate-300 rounded-xl px-3 py-2" id="gq" placeholder="é¡Œç›®ï¼ˆå¯å«ç©ºæ ¼ï¼šä¾‹å¦‚ ç”¨ ~ê³  ë‚˜ì„œ é€ å¥ï¼‰ã€ />
            <input required class="w-full border border-slate-300 rounded-xl px-3 py-2" id="ga" placeholder="æ­£ç¢ºç­”æ¡ˆï¼ˆæˆ–é¸é …ç´¢å¼• 0-3ï¼‰ã€ />
            <input class="w-full border border-slate-300 rounded-xl px-3 py-2" id="gopts" placeholder="é¸é …ï¼ˆä»¥ | åˆ†éš”ï¼Œå¯ç•™ç©ºä»£è¡¨ä¸»è§€é¡Œï¼‰ã€ />
            <textarea class="w-full border border-slate-300 rounded-xl px-3 py-2" id="gexp" placeholder="è§£èªªï¼ˆå¯ç©ºï¼‰"></textarea>
            <button class="btn btn-primary w-full" type="submit">åŠ å…¥é¡Œç›®</button>
          </form>
        </aside>
      </div>
    </section>

    <section id="panel-vocab" class="tab-panel hidden">
      <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6">
        <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-3 mb-3">
          <input id="v-search" class="border border-slate-300 rounded-xl px-3 py-2 flex-1" placeholder="æœå°‹ éŸ“æ–‡/é‡‹ç¾©/è¨»è¨˜/è©æ€§â€¦" />
          <select id="v-sort" class="border border-slate-300 rounded-xl px-3 py-2">
            <option value="ko">æŒ‰éŸ“æ–‡</option>
            <option value="meaning">æŒ‰é‡‹ç¾©</option>
            <option value="box">æŒ‰ç›’ä½ï¼ˆå‡åºï¼‰</option>
            <option value="level">æŒ‰é›£åº¦</option>
            <option value="nextDue">æŒ‰åˆ°æœŸæ—¥</option>
          </select>
          <button id="btn-add-vocab" class="btn btn-primary">æ–°å¢å–®å­—</button>
        </div>
        <div id="vocab-table" class="overflow-auto">
          <!-- table will render here -->
        </div>
      </div>
    </section>

    <section id="panel-settings" class="tab-panel hidden">
      <div class="grid md:grid-cols-2 gap-4 items-start">
        <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6 space-y-3">
          <h2 class="font-semibold">è¨­å®š</h2>
          <label class="block text-sm">Leitner é–“éš”ï¼ˆå¤©ï¼Œé€—è™Ÿåˆ†éš”ï¼‰ï¼š
            <input id="s-intervals" class="w-full border border-slate-300 rounded-xl px-3 py-2 mt-1" />
          </label>
          <label class="block text-sm">æ¯æ—¥æ–°å¡ä¸Šé™ï¼š
            <input id="s-daily" type="number" min="1" class="w-full border border-slate-300 rounded-xl px-3 py-2 mt-1" />
          </label>
          <div class="flex gap-2 pt-2">
            <button id="btn-save-settings" class="btn btn-primary">å„²å­˜è¨­å®š</button>
            <button id="btn-reset" class="btn" title="æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ˆä¸å¯å¾©åŸï¼‰">é‡è¨­è³‡æ–™åº«</button>
          </div>
        </div>
        <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6 space-y-3">
          <h2 class="font-semibold">åŒ¯å…¥ / åŒ¯å‡º</h2>
          <div class="flex gap-2 items-center">
            <button id="btn-export" class="btn">åŒ¯å‡º JSON</button>
            <input type="file" id="file-import" accept="application/json" class="hidden" />
            <button id="btn-import" class="btn">åŒ¯å…¥ JSON</button>
          </div>
          <p class="text-sm text-slate-600">å‚™ä»½åŒ…å«å–®å­—åº«ã€Leitner ç›’ä½/åˆ°æœŸæ—¥ã€æ–‡æ³•é¡Œåº«èˆ‡çµ±è¨ˆã€‚å¯è·¨è£ç½®å¾©åŸã€‚</p>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-500">
      MIT License Â· æœ¬å·¥å…·åœ¨ä½ çš„ç€è¦½å™¨ç«¯é‹è¡Œï¼Œè³‡æ–™åªå­˜æ–¼ localStorageã€‚
    </footer>
  </div>

<script>
// ====== Data Model & Storage ======
const LS_KEY = 'krstudy_data_v1';
const todayStr = () => new Date().toISOString().slice(0,10);
const uid = () => Math.random().toString(36).slice(2,10);

const SAMPLE_DATA = {
  settings: { leitnerIntervals: [0,1,2,4,7,15], dailyNew: 20 },
  stats: { review: {}, quiz: { mcqCorrect:0, mcqTotal:0, spellCorrect:0, spellTotal:0 } },
  vocab: [
    { id: uid(), ko: 'ì•ˆë…•í•˜ì„¸ìš”', reading: 'annyeonghaseyo', pos: 'ê°íƒ„ì‚¬', meaning: 'ä½ å¥½ï¼ˆæ‚¨å¥½ï¼‰', examples: 'ì•ˆë…•í•˜ì„¸ìš”? ë§Œë‚˜ì„œ ë°˜ê°€ì›Œìš”.', tags: 'æ‰“æ‹›å‘¼', level: 1, box: 1, nextDue: todayStr() },
    { id: uid(), ko: 'í•™êµ', reading: 'hakgyo', pos: 'ëª…ì‚¬', meaning: 'å­¸æ ¡', examples: 'ì €ëŠ” í•™êµì— ê°€ìš”.', tags: 'å ´æ‰€', level: 1, box: 1, nextDue: todayStr() },
    { id: uid(), ko: 'ë¨¹ë‹¤', reading: 'meokda', pos: 'ë™ì‚¬', meaning: 'åƒ', examples: 'ë°¥ì„ ë¨¹ì–´ìš”.', tags: 'å‹•ä½œ', level: 1, box: 1, nextDue: todayStr() },
    { id: uid(), ko: 'ì˜ˆì˜ë‹¤', reading: 'yeppeuda', pos: 'í˜•ìš©ì‚¬', meaning: 'æ¼‚äº®', examples: 'ê½ƒì´ ì˜ˆë»ìš”.', tags: 'å½¢å®¹', level: 2, box: 1, nextDue: todayStr() },
    { id: uid(), ko: 'ì±…', reading: 'chaek', pos: 'ëª…ì‚¬', meaning: 'æ›¸', examples: 'ì±…ì„ ì½ì–´ìš”.', tags: 'ç‰©å“', level: 1, box: 1, nextDue: todayStr() },
  ],
  grammar: [
    { id: uid(), question: 'ã€Œ-ê³  ë‚˜ì„œã€çš„ç”¨æ³•æ˜¯ï¼Ÿ', options: ['è¡¨ç¤ºåŒæ™‚é€²è¡Œ','è¡¨ç¤ºå‹•ä½œçµæŸå¾Œ','è¡¨ç¤ºåŸå› ','è¡¨ç¤ºå°æ¯”'], answer: 1, explanation: 'ã€Œ-ê³  ë‚˜ì„œã€è¡¨ç¤ºåšå®Œå‰ä¸€å€‹å‹•ä½œä¹‹å¾Œå†åšå¾Œä¸€å€‹å‹•ä½œã€‚' },
    { id: uid(), question: 'è«‹ç”¨ã€Œ-ì§€ë§Œã€é€ å¥è¡¨å°æ¯”ï¼ˆä¸»è§€é¡Œï¼‰', options: [], answer: 'é–‹æ”¾ä½œç­”', explanation: 'ä¾‹å¦‚: ë¹„ì‹¸ì§€ë§Œ ì¢‹ì•„ìš”.' }
  ]
};

function loadData(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){ saveData(structuredClone(SAMPLE_DATA)); return structuredClone(SAMPLE_DATA); }
    const data = JSON.parse(raw);
    // migrate fields if needed
    data.settings ||= { leitnerIntervals:[0,1,2,4,7,15], dailyNew:20 };
    data.stats ||= { review:{}, quiz:{ mcqCorrect:0, mcqTotal:0, spellCorrect:0, spellTotal:0 } };
    data.vocab ||= [];
    data.grammar ||= [];
    return data;
  }catch(e){ console.error(e); alert('è³‡æ–™è®€å–éŒ¯èª¤ï¼Œå·²è¼‰å…¥é è¨­è³‡æ–™'); saveData(SAMPLE_DATA); return structuredClone(SAMPLE_DATA); }
}
function saveData(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
let DB = loadData();

// ====== Tabs ======
const tabs = document.querySelectorAll('.tab-btn');
const panels = {
  review: document.getElementById('panel-review'),
  quiz: document.getElementById('panel-quiz'),
  grammar: document.getElementById('panel-grammar'),
  vocab: document.getElementById('panel-vocab'),
  settings: document.getElementById('panel-settings'),
};

tabs.forEach(btn=>btn.addEventListener('click',()=>{
  tabs.forEach(b=>b.classList.remove('tab-active'));
  btn.classList.add('tab-active');
  Object.values(panels).forEach(p=>p.classList.add('hidden'));
  panels[btn.dataset.tab].classList.remove('hidden');
  if(btn.dataset.tab==='vocab') renderVocab();
  if(btn.dataset.tab==='settings') renderSettings();
  if(btn.dataset.tab==='review') refreshReview();
  if(btn.dataset.tab==='quiz') newMCQ()||newSpell();
}));

// ====== Leitner Review ======
const cardFront = document.getElementById('card-front');
const cardBack = document.getElementById('card-back');
const cardMeaning = document.getElementById('card-meaning');
const cardExample = document.getElementById('card-example');
const cardMeta = document.getElementById('card-meta');
const btnShow = document.getElementById('btn-show');
const btnForgot = document.getElementById('btn-forgot');
const btnGood = document.getElementById('btn-good');
const btnSkip = document.getElementById('btn-skip');
const statsEl = document.getElementById('review-stats');
const boxesEl = document.getElementById('leitner-boxes');
let reviewQueue = [];
let currentCard = null;

function nextDueDate(box){
  const d = new Date();
  const days = DB.settings.leitnerIntervals[Math.min(box-1, DB.settings.leitnerIntervals.length-1)] || 0;
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}

function buildReviewQueue(){
  const today = todayStr();
  reviewQueue = DB.vocab.filter(v=>v.nextDue<=today).sort((a,b)=> (a.box-b.box)||a.ko.localeCompare(b.ko));
}

function refreshBoxes(){
  boxesEl.innerHTML='';
  const counts = [0,0,0,0,0,0,0];
  DB.vocab.forEach(v=>{ counts[v.box||1] = (counts[v.box||1]||0)+1; });
  for(let i=1;i<=6;i++){
    const div = document.createElement('div');
    div.className='p-2 rounded-xl border border-slate-200 bg-white';
    div.innerHTML = `<div class="text-xs text-slate-500">ç›’ ${i}</div><div class="text-lg font-semibold">${counts[i]||0}</div>`;
    boxesEl.appendChild(div);
  }
}

function refreshReview(){
  buildReviewQueue();
  refreshBoxes();
  statsEl.textContent = `åˆ°æœŸï¼š${reviewQueue.length} å¼µ`;
  drawNextCard();
}

function drawNextCard(){
  currentCard = reviewQueue.shift() || null;
  if(!currentCard){
    cardFront.textContent='ğŸ‰ ä»Šæ—¥æ²’æœ‰åˆ°æœŸçš„å¡ç‰‡äº†ï¼';
    cardMeta.textContent='å¯åˆ°ã€Œå–®å­—åº«ã€æ–°å¢å–®å­—ï¼Œæˆ–åˆ°ã€Œæ¸¬é©—ã€ç·´ç¿’ã€‚';
    cardBack.classList.add('hidden');
    btnShow.disabled = true; btnForgot.disabled = true; btnGood.disabled = true;
    return;
  }
  btnShow.disabled = false; btnForgot.disabled = true; btnGood.disabled = true;
  cardBack.classList.add('hidden');
  cardFront.textContent = currentCard.ko;
  cardMeta.textContent = `${currentCard.pos||''} Â· ç›’${currentCard.box} Â· åˆ°æœŸ ${currentCard.nextDue}`;
  cardMeaning.textContent = currentCard.meaning || '';
  cardExample.textContent = currentCard.examples? `ä¾‹ï¼š${currentCard.examples}` : '';
}

btnShow.addEventListener('click', ()=>{ cardBack.classList.remove('hidden'); btnForgot.disabled=false; btnGood.disabled=false; });
btnForgot.addEventListener('click', ()=>{
  if(!currentCard) return;
  currentCard.box = 1;
  currentCard.nextDue = nextDueDate(currentCard.box);
  saveData(DB);
  refreshReview();
});
btnGood.addEventListener('click', ()=>{
  if(!currentCard) return;
  currentCard.box = Math.min((currentCard.box||1)+1, 6);
  currentCard.nextDue = nextDueDate(currentCard.box);
  saveData(DB);
  refreshReview();
});
btnSkip.addEventListener('click', ()=>{ drawNextCard(); });

// ====== Quiz: MCQ & Spelling ======
const mcqQ = document.getElementById('mcq-question');
const mcqOpts = document.getElementById('mcq-options');
const mcqFb = document.getElementById('mcq-feedback');
const btnNextMcq = document.getElementById('btn-next-mcq');
const spellPrompt = document.getElementById('spell-prompt');
const spellInput = document.getElementById('spell-input');
const spellFb = document.getElementById('spell-feedback');
const btnNextSpell = document.getElementById('btn-next-spell');
const btnCheckSpell = document.getElementById('btn-check-spell');
const btnShowSpell = document.getElementById('btn-show-spell');

let mcqAnswer = null;
function pickN(arr,n){ const a=[...arr]; const out=[]; while(a.length && out.length<n){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }
function newMCQ(){
  const pool = DB.vocab.filter(v=>v.meaning && v.ko);
  if(pool.length<4){ mcqQ.textContent='ï¼ˆå–®å­—ä¸è¶³ 4 ç­†ï¼Œè«‹å…ˆæ–°å¢å–®å­—ï¼‰'; mcqOpts.innerHTML=''; return; }
  const correct = pool[Math.floor(Math.random()*pool.length)];
  const distractors = pickN(pool.filter(v=>v.id!==correct.id),3);
  const options = [correct, ...distractors].sort(()=>Math.random()-0.5);
  mcqAnswer = correct.id;
  mcqQ.textContent = `ã€Œ${correct.meaning}ã€çš„éŸ“æ–‡æ˜¯ï¼Ÿ`;
  mcqOpts.innerHTML = '';
  options.forEach(o=>{
    const b = document.createElement('button');
    b.className='btn w-full text-left';
    b.textContent = `${o.ko}  Â·  ${o.reading||''}`;
    b.addEventListener('click',()=>{
      DB.stats.quiz.mcqTotal++;
      if(o.id===mcqAnswer){ DB.stats.quiz.mcqCorrect++; mcqFb.textContent='âœ… æ­£ç¢º'; b.classList.add('btn-primary'); }
      else{ mcqFb.textContent=`âŒ éŒ¯èª¤ï¼Œæ­£ç¢ºï¼š${correct.ko}`; }
      saveData(DB);
    });
    mcqOpts.appendChild(b);
  });
  mcqFb.textContent='';
}
btnNextMcq.addEventListener('click', newMCQ);

let spellAnswer = null;
function newSpell(){
  const pool = DB.vocab.filter(v=>v.meaning && v.ko);
  if(pool.length<1){ spellPrompt.textContent='ï¼ˆè«‹å…ˆæ–°å¢å–®å­—ï¼‰'; return; }
  const q = pool[Math.floor(Math.random()*pool.length)];
  spellAnswer = q.ko;
  spellPrompt.textContent = `è«‹è¼¸å…¥ï¼š${q.meaning}`;
  spellInput.value=''; spellFb.textContent=''; spellInput.focus();
}
btnNextSpell.addEventListener('click', newSpell);
btnShowSpell.addEventListener('click', ()=>{ spellFb.textContent = `ç­”æ¡ˆï¼š${spellAnswer}`; });
btnCheckSpell.addEventListener('click', ()=>{
  const ans = (spellInput.value||'').trim();
  DB.stats.quiz.spellTotal++;
  if(ans===spellAnswer){ DB.stats.quiz.spellCorrect++; spellFb.textContent='âœ… æ­£ç¢º'; }
  else{ spellFb.textContent = `âŒ éŒ¯èª¤ï¼Œç­”æ¡ˆï¼š${spellAnswer}`; }
  saveData(DB);
});

// ====== Grammar ======
const gramQ = document.getElementById('gram-question');
const gramOpts = document.getElementById('gram-options');
const gramFb = document.getElementById('gram-feedback');
const btnNextGram = document.getElementById('btn-next-gram');
const gramForm = document.getElementById('gram-form');

function newGram(){
  if(DB.grammar.length===0){ gramQ.textContent='ï¼ˆå°šç„¡æ–‡æ³•é¡Œï¼Œè«‹å³å´æ–°å¢ï¼‰'; gramOpts.innerHTML=''; gramFb.textContent=''; return; }
  const q = DB.grammar[Math.floor(Math.random()*DB.grammar.length)];
  gramQ.textContent = q.question;
  gramOpts.innerHTML='';
  gramFb.textContent='';
  if(q.options && q.options.length){
    q.options.forEach((opt,idx)=>{
      const b=document.createElement('button');
      b.className='btn w-full text-left';
      b.textContent = `${String.fromCharCode(65+idx)}. ${opt}`;
      b.addEventListener('click',()=>{
        if(idx===q.answer){ gramFb.textContent='âœ… æ­£ç¢º'; b.classList.add('btn-primary'); }
        else{ gramFb.textContent = `âŒ éŒ¯èª¤ã€‚æ­£ç¢ºï¼š${String.fromCharCode(65+q.answer)}. ${q.options[q.answer]}`; }
        if(q.explanation) gramFb.textContent += `\nğŸ’¡ ${q.explanation}`;
      });
      gramOpts.appendChild(b);
    });
  }else{
    const input=document.createElement('textarea');
    input.className='w-full border border-slate-300 rounded-xl px-3 py-2';
    input.placeholder='è«‹åœ¨æ­¤ä½œç­”â€¦';
    gramOpts.appendChild(input);
    const chk=document.createElement('button');
    chk.className='btn mt-2 btn-primary';
    chk.textContent='åƒè€ƒç­”æ¡ˆ';
    chk.addEventListener('click',()=>{
      gramFb.textContent = `åƒè€ƒï¼š${q.answer || 'ï¼ˆé–‹æ”¾ä½œç­”ï¼‰'}` + (q.explanation? `\nğŸ’¡ ${q.explanation}` : '');
    });
    gramOpts.appendChild(chk);
  }
}
btnNextGram.addEventListener('click', newGram);

gramForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const q = document.getElementById('gq').value.trim();
  const a = document.getElementById('ga').value.trim();
  const optsRaw = document.getElementById('gopts').value.trim();
  const exp = document.getElementById('gexp').value.trim();
  if(!q||!a) return;
  const opts = optsRaw? optsRaw.split('|').map(s=>s.trim()) : [];
  const answer = opts.length? Math.max(0, Math.min(opts.length-1, parseInt(a))) : a;
  DB.grammar.push({ id: uid(), question:q, options:opts, answer, explanation:exp });
  saveData(DB);
  e.target.reset();
  alert('å·²åŠ å…¥æ–‡æ³•é¡Œ');
  newGram();
});

// ====== Vocab CRUD ======
const vSearch = document.getElementById('v-search');
const vSort = document.getElementById('v-sort');
const vTable = document.getElementById('vocab-table');

document.getElementById('btn-add-vocab').addEventListener('click', ()=> editVocab());

function renderVocab(){
  const q = (vSearch.value||'').toLowerCase();
  const sortBy = vSort.value;
  let list = DB.vocab.filter(v=> !q || [v.ko,v.meaning,v.tags,v.pos].join(' ').toLowerCase().includes(q));
  list.sort((a,b)=>{
    if(sortBy==='box'||sortBy==='level') return (a[sortBy]||0)-(b[sortBy]||0);
    if(sortBy==='nextDue') return (a.nextDue||'').localeCompare(b.nextDue||'');
    return (a[sortBy]||'').localeCompare(b[sortBy]||'');
  });
  const rows = list.map(v=>`<tr class="border-b">\n    <td class="p-2 font-semibold">${v.ko}</td>\n    <td class="p-2">${v.meaning||''}</td>\n    <td class="p-2 text-xs text-slate-500">${v.reading||''}</td>\n    <td class="p-2 text-xs">${v.pos||''}</td>\n    <td class="p-2 text-xs">ç›’${v.box||1}</td>\n    <td class="p-2 text-xs">${v.nextDue||''}</td>\n    <td class="p-2 text-xs">${v.tags||''}</td>\n    <td class="p-2 text-right">\n      <button class="btn btn-ghost" data-act="edit" data-id="${v.id}">ç·¨è¼¯</button>\n      <button class="btn" data-act="review-now" data-id="${v.id}">ä»Šæ—¥è¤‡ç¿’</button>\n      <button class="btn" data-act="del" data-id="${v.id}">åˆªé™¤</button>\n    </td>\n  </tr>`).join('');
  vTable.innerHTML = `<table class="w-full text-sm">\n    <thead><tr class="text-left text-xs text-slate-500 border-b">\n      <th class="p-2">éŸ“æ–‡</th><th class="p-2">é‡‹ç¾©</th><th class="p-2">è®€éŸ³</th><th class="p-2">è©æ€§</th><th class="p-2">ç›’ä½</th><th class="p-2">åˆ°æœŸ</th><th class="p-2">æ¨™ç±¤</th><th class="p-2"></th>\n    </tr></thead>\n    <tbody>${rows}</tbody>\n  </table>`;
  vTable.querySelectorAll('button[data-id]').forEach(btn=>{
    const id = btn.dataset.id; const act = btn.dataset.act;
    btn.addEventListener('click', ()=>{
      if(act==='edit') editVocab(DB.vocab.find(v=>v.id===id));
      if(act==='del') { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ DB.vocab = DB.vocab.filter(v=>v.id!==id); saveData(DB); renderVocab(); refreshReview(); } }
      if(act==='review-now'){ const v=DB.vocab.find(v=>v.id===id); v.nextDue=todayStr(); saveData(DB); alert('å·²è¨­ç‚ºä»Šæ—¥åˆ°æœŸ'); refreshReview(); }
    });
  });
}

function editVocab(item){
  const data = item || { id: uid(), ko:'', reading:'', pos:'', meaning:'', examples:'', tags:'', level:1, box:1, nextDue: todayStr() };
  const wrapper = document.createElement('div');
  wrapper.className='fixed inset-0 bg-black/30 flex items-center justify-center p-4';
  wrapper.innerHTML = `
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
      <h3 class="font-semibold mb-3">${item? 'ç·¨è¼¯å–®å­—' : 'æ–°å¢å–®å­—'}</h3>
      <div class="grid md:grid-cols-2 gap-3 text-sm">
        <label>éŸ“æ–‡<input id="ek" class="w-full border border-slate-300 rounded-xl px-3 py-2" value="${data.ko}"></label>
        <label>è®€éŸ³<input id="er" class="w-full border border-slate-300 rounded-xl px-3 py-2" value="${data.reading}"></label>
        <label>è©æ€§<input id="ep" class="w-full border border-slate-300 rounded-xl px-3 py-2" value="${data.pos}"></label>
        <label>é‡‹ç¾©<input id="em" class="w-full border border-slate-300 rounded-xl px-3 py-2" value="${data.meaning}"></label>
        <label class="md:col-span-2">ä¾‹å¥<textarea id="ee" class="w-full border border-slate-300 rounded-xl px-3 py-2">${data.examples}</textarea></label>
        <label>æ¨™ç±¤<input id="et" class="w-full border border-slate-300 rounded-xl px-3 py-2" value="${data.tags}"></label>
        <label>é›£åº¦<input id="el" type="number" min="1" max="5" class="w-full border border-slate-300 rounded-xl px-3 py-2" value="${data.level}"></label>
        <label>ç›’ä½<input id="eb" type="number" min="1" max="6" class="w-full border border-slate-300 rounded-xl px-3 py-2" value="${data.box}"></label>
        <label>åˆ°æœŸ<input id="ed" type="date" class="w-full border border-slate-300 rounded-xl px-3 py-2" value="${data.nextDue}"></label>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button class="btn" id="cancel">å–æ¶ˆ</button>
        ${item? '<button class="btn" id="delete">åˆªé™¤</button>' : ''}
        <button class="btn btn-primary" id="save">å„²å­˜</button>
      </div>
    </div>`;
  document.body.appendChild(wrapper);
  wrapper.querySelector('#cancel').onclick=()=>wrapper.remove();
  if(item){ wrapper.querySelector('#delete').onclick=()=>{ if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ DB.vocab = DB.vocab.filter(v=>v.id!==item.id); saveData(DB); renderVocab(); refreshReview(); wrapper.remove(); } } }
  wrapper.querySelector('#save').onclick=()=>{
    const v = {
      id: data.id,
      ko: wrapper.querySelector('#ek').value.trim(),
      reading: wrapper.querySelector('#er').value.trim(),
      pos: wrapper.querySelector('#ep').value.trim(),
      meaning: wrapper.querySelector('#em').value.trim(),
      examples: wrapper.querySelector('#ee').value.trim(),
      tags: wrapper.querySelector('#et').value.trim(),
      level: parseInt(wrapper.querySelector('#el').value)||1,
      box: Math.max(1, Math.min(6, parseInt(wrapper.querySelector('#eb').value)||1 )),
      nextDue: wrapper.querySelector('#ed').value || todayStr(),
    };
    if(!v.ko || !v.meaning){ alert('éŸ“æ–‡èˆ‡é‡‹ç¾©ç‚ºå¿…å¡«'); return; }
    if(item){ const idx = DB.vocab.findIndex(x=>x.id===item.id); DB.vocab[idx]=v; }
    else{ DB.vocab.push(v); }
    saveData(DB); renderVocab(); refreshReview(); wrapper.remove();
  };
}

vSearch.addEventListener('input', renderVocab);
vSort.addEventListener('change', renderVocab);

// ====== Settings / Import / Export ======
const sIntervals = document.getElementById('s-intervals');
const sDaily = document.getElementById('s-daily');
const btnSaveSettings = document.getElementById('btn-save-settings');
const btnReset = document.getElementById('btn-reset');
const btnExport = document.getElementById('btn-export');
const btnImport = document.getElementById('btn-import');
const fileImport = document.getElementById('file-import');

function renderSettings(){
  sIntervals.value = (DB.settings.leitnerIntervals||[0,1,2,4,7,15]).join(',');
  sDaily.value = DB.settings.dailyNew||20;
}
btnSaveSettings.addEventListener('click', ()=>{
  const intervals = sIntervals.value.split(',').map(s=>parseInt(s.trim())).filter(n=>!Number.isNaN(n));
  DB.settings.leitnerIntervals = intervals.length? intervals : [0,1,2,4,7,15];
  DB.settings.dailyNew = Math.max(1, parseInt(sDaily.value)||20);
  saveData(DB);
  alert('è¨­å®šå·²å„²å­˜');
});

btnReset.addEventListener('click', ()=>{
  if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')){ DB = structuredClone(SAMPLE_DATA); saveData(DB); location.reload(); }
});

btnExport.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(DB, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `krstudy-backup-${todayStr()}.json`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});

btnImport.addEventListener('click', ()=> fileImport.click());
fileImport.addEventListener('change', (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if(!data.vocab || !data.grammar) throw new Error('æ ¼å¼ä¸æ­£ç¢º');
      DB = data; saveData(DB); alert('åŒ¯å…¥æˆåŠŸ'); location.reload();
    }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message); }
  };
  reader.readAsText(file);
});

// ====== Init ======
function init(){
  refreshReview();
  newMCQ();
  newSpell();
  newGram();
}
init();

</script>
</body>
</html>
